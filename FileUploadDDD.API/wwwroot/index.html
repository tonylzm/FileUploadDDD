<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文件上传网站</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }

        form {
            margin-bottom: 30px;
        }

        .file-input {
            margin: 10px 0;
        }

        .msg {
            margin-top: 10px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        a {
            color: blue;
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <h1>📁 文件上传与下载</h1>

    <form id="uploadForm">
        <div class="file-input">
            <label for="fileInput">选择文件：</label>
            <input type="file" id="fileInput" name="file" required />
        </div>
        <button type="submit">📤 上传文件</button>
    </form>

    <div id="uploadMessage"></div>

    <h2>📋 已上传的文件</h2>

    <div id="fileList">
        <p><em>加载中...</em></p>
    </div>

    <script>
        //上传文件
        document.getElementById('uploadForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const token = localStorage.getItem('authToken');

            if (!file) {
                alert('请选择一个文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const messageDiv = document.getElementById('uploadMessage');
            messageDiv.innerHTML = '<p class="msg">正在上传...</p>';

            try {
                const response = await fetch('https://localhost:7178/api/file/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = `
                        <p class="success">
                            上传成功！<br/>
                            文件名：${result.fileName || file.name}<br/>
                            文件大小：${(result.fileSize / 1024).toFixed(2) || '未知'}KB<br/>
                        </p>`;
                    loadFileList(); // 重新加载文件列表
                } else {
                    const errorText = await response.text();
                    messageDiv.innerHTML = `<p class="error">上传失败：${errorText}</p>`;
                }
            } catch (err) {
                messageDiv.innerHTML = `<p class="error">网络错误：${err.message}</p>`;
            }
        });

        async function loadFileList() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '<p><em>加载文件列表中...</em></p>';

            try {
                            
                const response = await fetch('https://localhost:7178/api/file/list');
                const files = await response.json();
                let html = '<table><tr><th>ID</th><th>文件名</th><th>存储名</th><th>上传时间</th><th>文件大小</th><th>操作</th></tr>';
                files.forEach(f => {
                    html += `<tr>
                        <td>${f.id}</td>
                        <td>${f.fileName}</td>
                        <td>${f.storedFileName}</td>
                        <td>${f.uploadTime}</td>
                        <td>${(f.fileSize / 1024).toFixed(2) }KB</td>
                        <td>
                          <button onclick="downloadFile(${f.id})">下载</button>
                          <button onclick="deleteFile(${f.id})">删除</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                fileListDiv.innerHTML = html;
               
            } catch (err) {
                fileListDiv.innerHTML = `<p class="error">❌ 加载文件列表失败：${err.message}</p>`;
            }
        }

        async function downloadFile(fileId) {
            const token = localStorage.getItem('authToken'); 

            if (!token) {
                alert('未登录或 Token 不存在');
                return;
            }

            try {
                const response = await fetch(`https://localhost:7178/api/file/download/${fileId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}` // ⬅️ 关键：带上 Token
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    alert(`下载失败: 身份信息已过期！请重新登录！`);
                    return;
                }

                //读取文件流并触发浏览器下载
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `file-${fileId}.xlsx`
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

            } catch (error) {
                console.error('下载出错:身份信息已过期！请重新登录！');
                alert('下载失败，请重试');
            }
        }
        //删除文件
        async function deleteFile(fileId) {
            
            const token = localStorage.getItem('authToken');

            if (!token) {
                alert('未登录或 Token 不存在');
                return;
            }

            try {
                const response = await fetch(`https://localhost:7178/api/file/delete/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    alert(`删除失败: 身份信息已过期！请重新登录！`);
                    return;
                }
                loadFileList();
                alert(`删除成功！`);

            } catch (error) {
                console.error('删除失败:身份信息已过期！请重新登录！');
                alert('删除失败，请重试');
            }
        }
        // 页面加载时尝试获取文件列表
        loadFileList();
    </script>

</body>
</html>